# Architecture Diagrams

## System Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                         Client Layer                             │
│              (HTTP/REST API, WebSocket, CLI)                     │
└────────────────────────────┬────────────────────────────────────┘
                             │
┌────────────────────────────▼────────────────────────────────────┐
│                    FastAPI Application Layer                      │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  Middleware: CORS, Rate Limiting, Request Timing         │  │
│  └──────────────────────────────────────────────────────────┘  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐        │
│  │ Query API    │  │ Health API   │  │ Conversation │        │
│  └──────────────┘  └──────────────┘  └──────────────┘        │
└────────────────────────────┬────────────────────────────────────┘
                             │
┌────────────────────────────▼────────────────────────────────────┐
│                  Agent Orchestration Layer                        │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │              AgentOrchestrator                             │  │
│  │  - Routes queries to appropriate agents                    │  │
│  │  - Manages agent lifecycle                                │  │
│  └──────────────────────────────────────────────────────────┘  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐        │
│  │ Query Agent  │  │ Data Agent   │  │ Format Agent │        │
│  └──────────────┘  └──────────────┘  └──────────────┘        │
└────────────────────────────┬────────────────────────────────────┘
                             │
┌────────────────────────────▼────────────────────────────────────┐
│              LangGraph ReAct Agent Framework                     │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  - Reasoning Loop                                         │  │
│  │  - Tool Selection                                         │  │
│  │  - Action Execution                                       │  │
│  │  - Memory Management (InMemorySaver)                      │  │
│  └──────────────────────────────────────────────────────────┘  │
└────────────────────────────┬────────────────────────────────────┘
                             │
┌────────────────────────────▼────────────────────────────────────┐
│              Model Context Protocol (MCP) Layer                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  MCPClient: Manages MCP server connections                 │  │
│  │  - Stdio communication                                     │  │
│  │  - Session management                                      │  │
│  │  - Tool loading                                            │  │
│  └──────────────────────────────────────────────────────────┘  │
└────────────────────────────┬────────────────────────────────────┘
                             │
┌────────────────────────────▼────────────────────────────────────┐
│                    Data & Infrastructure Layer                    │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐        │
│  │  Couchbase   │  │    Redis     │  │   LLM API    │        │
│  │  Database    │  │    Cache     │  │  (Nebius)    │        │
│  └──────────────┘  └──────────────┘  └──────────────┘        │
└─────────────────────────────────────────────────────────────────┘
```

## Request Flow

```
1. Client Request
   ↓
2. FastAPI Endpoint (with middleware)
   ↓
3. Agent Orchestrator
   ↓
4. Specialized Agent (e.g., QueryAgent)
   ↓
5. LangGraph ReAct Agent
   ↓
6. Tool Selection & Execution
   ↓
7. MCP Client → MCP Server
   ↓
8. Couchbase Database Query
   ↓
9. Response Processing
   ↓
10. Caching (if enabled)
   ↓
11. Client Response
```

## Component Interaction

```
┌─────────────┐
│   Client    │
└──────┬──────┘
       │ HTTP Request
       ▼
┌─────────────────┐      ┌──────────────┐
│  FastAPI App    │─────▶│ Rate Limiter │
└──────┬──────────┘      └──────────────┘
       │
       ▼
┌─────────────────┐      ┌──────────────┐
│   Orchestrator  │─────▶│ Cache Manager│
└──────┬──────────┘      └──────────────┘
       │
       ▼
┌─────────────────┐      ┌──────────────┐
│  ReAct Agent    │─────▶│   Metrics    │
└──────┬──────────┘      └──────────────┘
       │
       ▼
┌─────────────────┐      ┌──────────────┐
│   MCP Client    │─────▶│   Logger     │
└──────┬──────────┘      └──────────────┘
       │
       ▼
┌─────────────────┐
│  Couchbase DB   │
└─────────────────┘
```

## Deployment Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                    Load Balancer / API Gateway                │
└────────────────────────────┬────────────────────────────────┘
                             │
        ┌────────────────────┼────────────────────┐
        │                    │                    │
┌───────▼──────┐    ┌───────▼──────┐    ┌───────▼──────┐
│   API Pod 1  │    │   API Pod 2  │    │   API Pod N  │
│  (FastAPI)   │    │  (FastAPI)   │    │  (FastAPI)   │
└───────┬──────┘    └───────┬──────┘    └───────┬──────┘
        │                    │                    │
        └────────────────────┼────────────────────┘
                             │
        ┌────────────────────┼────────────────────┐
        │                    │                    │
┌───────▼──────┐    ┌───────▼──────┐    ┌───────▼──────┐
│  Redis Pod   │    │  MCP Server  │    │  Couchbase   │
│   (Cache)    │    │   (Tools)    │    │  (Database)  │
└──────────────┘    └──────────────┘    └──────────────┘
```

## Monitoring Stack

```
┌──────────────┐
│  Prometheus  │◀─── Metrics from API
└──────┬───────┘
       │
       ▼
┌──────────────┐
│   Grafana    │───▶ Dashboards & Alerts
└──────────────┘

┌──────────────┐
│  Structured   │───▶ Log Aggregation
│    Logs      │     (JSON format)
└──────────────┘

┌──────────────┐
│ Distributed  │───▶ Tracing (OpenTelemetry ready)
│   Tracing    │
└──────────────┘
```

